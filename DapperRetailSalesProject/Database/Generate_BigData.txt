-- =============================================
-- Project: S-Retail AI Analysis Panel
-- Author: Merve Yıldız
-- Description: Synthetic Big Data Generation & ETL Process
-- =============================================

USE RetailInsightsDB;
GO

-- 1. ADIM: TABLO KURULUMU (SCHEMA SETUP)
-- Eğer tablo yoksa, Computed Column (Otomatik Hesaplama) mantığıyla oluştur.
IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='RetailSales' AND xtype='U')
BEGIN
    CREATE TABLE RetailSales (
        Id INT PRIMARY KEY IDENTITY(1,1),
        SaleDate DATETIME NOT NULL,
        StoreFormat NVARCHAR(50),
        CategoryName NVARCHAR(50),
        ProductName NVARCHAR(100),
        UnitPrice DECIMAL(18,2), -- Birim Fiyat
        Quantity INT,            -- Adet
        TotalPrice AS (UnitPrice * Quantity) PERSISTED, -- Toplam (Otomatik Hesaplanır)
        City NVARCHAR(50)
    );
    PRINT 'Tablo başarıyla oluşturuldu.';
END
GO

-- 2. ADIM: SENTETİK VERİ ÜRETİMİ (DATA GENERATION)
-- 10.000 Adet Rastgele Veri Basalım (Döngü ile)
DECLARE @i INT = 0;
WHILE @i < 10000
BEGIN
    INSERT INTO RetailSales (SaleDate, StoreFormat, CategoryName, ProductName, UnitPrice, Quantity, City)
    VALUES (
        DATEADD(DAY, -ABS(CHECKSUM(NEWID()) % 365), GETDATE()), -- Son 1 yıl içinden rastgele tarih
        CHOOSE(ABS(CHECKSUM(NEWID()) % 4) + 1, 'S-Online', 'S-Express', 'S-Super', 'S-Mega'), -- Format
        CHOOSE(ABS(CHECKSUM(NEWID()) % 5) + 1, 'Teknoloji', 'Gıda', 'Manav', 'Et & Balık', 'Kişisel Bakım'), -- Kategori
        CHOOSE(ABS(CHECKSUM(NEWID()) % 6) + 1, 'iPhone 15', 'Çaykur Rize Turist 1kg', 'Dana Kıyma 500gr', 'Nutella 750gr', 'Dove Şampuan', 'Samsung TV'), -- Ürün
        ABS(CHECKSUM(NEWID()) % 500) + 20, -- Fiyat (20 ile 520 arası)
        ABS(CHECKSUM(NEWID()) % 5) + 1,    -- Adet (1 ile 5 arası)
        'Istanbul' -- Şimdilik hepsi İstanbul (Aşağıda dağıtacağız)
    );
    SET @i = @i + 1;
END
PRINT 'Sentetik veriler başarıyla üretildi.';
GO

-- 3. ADIM: VERİ TEMİZLİĞİ VE ETL (DATA CLEANING)
-- Formatı NULL olanları yakala ve düzelt
UPDATE RetailSales 
SET StoreFormat = 'S-Mega' 
WHERE StoreFormat IS NULL OR StoreFormat = '' OR StoreFormat = 'null';

-- Formatları eşit dağıt
UPDATE RetailSales
SET StoreFormat = CHOOSE(ABS(CHECKSUM(NEWID()) % 4) + 1, 
    'S-Online', 'S-Express', 'S-Super', 'S-Mega');
PRINT 'Veri temizliği tamamlandı.';
GO

-- 4. ADIM: HARİTA OPTİMİZASYONU (MAP DATA DISTRIBUTION)
-- Google GeoChart için Şehir İsimlerini İngilizce Karakterle Dağıt
-- %30 İstanbul (Lider), %70 Anadolu

-- Önce Herkesi İstanbul Yap
UPDATE RetailSales SET City = 'Istanbul';

-- Anadolu'ya Yay (Türkçe karakter kullanmadan!)
UPDATE RetailSales
SET City = CHOOSE(ABS(CHECKSUM(NEWID()) % 15) + 1, 
    'Ankara', 'Izmir', 'Antalya', 'Bursa',        
    'Adana', 'Konya', 'Gaziantep', 'Sanliurfa',   
    'Trabzon', 'Samsun',                          
    'Eskisehir', 'Kayseri', 'Denizli',            
    'Van', 'Erzurum')               
WHERE ABS(CHECKSUM(NEWID()) % 100) < 70; -- %70 ihtimalle diğer şehirlere ata

PRINT 'Coğrafi dağılım (Harita verisi) tamamlandı.';
GO

-- 5. ADIM: SENARYO UYGULAMA (BUSINESS LOGIC)
-- Senaryo: İstanbul ve Turizm bölgelerinde fiyatlar daha yüksek olsun (Haritada Koyu Renk İçin)
-- DİKKAT: TotalPrice computed column olduğu için UnitPrice güncelliyoruz.
UPDATE RetailSales
SET UnitPrice = UnitPrice * 1.5
WHERE City IN ('Istanbul', 'Antalya', 'Izmir', 'Bodrum');

PRINT 'İş zekası senaryoları uygulandı. Veritabanı analize hazır!';
GO